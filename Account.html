<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ship Me · User Dashboard</title>
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0a1a3f;color:#fff}
    a{color:inherit}
    .dashboard-container{padding:40px 24px 80px;max-width:1200px;margin:0 auto}
    h1{font-size:2.2rem;margin:0 0 10px;letter-spacing:.4px}
    .subtitle{color:#c9d3ea;margin-bottom:32px}
    .overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:32px}
    .overview-card{background:rgba(255,255,255,.08);border-radius:16px;padding:24px 22px;border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 36px rgba(12,32,73,.28);transition:transform .2s,box-shadow .2s}
    .overview-card:hover{transform:translateY(-2px);box-shadow:0 24px 46px rgba(12,32,73,.32)}
    .overview-card h3{margin:0;font-size:.95rem;font-weight:600;color:#c9d3ea;letter-spacing:.4px}
    .overview-card .metric{margin-top:14px;font-size:1.9rem;font-weight:700;color:#61d3f9}
    .overview-card .meta{margin-top:12px;font-size:.9rem;color:rgba(255,255,255,.7)}
    .filters{display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
    .filters button{padding:10px 20px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;font-weight:600;cursor:pointer;transition:all .2s}
    .filters button.active,.filters button:hover{background:linear-gradient(135deg,#1c6bff,#4090ff);border-color:transparent;box-shadow:0 16px 32px rgba(28,107,255,.32)}
    .table-wrapper{background:rgba(255,255,255,.05);border-radius:18px;border:1px solid rgba(255,255,255,.12);overflow:hidden;box-shadow:0 18px 36px rgba(12,32,73,.32)}
    table{width:100%;border-collapse:collapse;min-width:760px}
    thead{background:rgba(255,255,255,.08)}
    th,td{padding:18px 20px;text-align:left;font-size:.95rem}
    th{text-transform:uppercase;letter-spacing:.6px;font-size:.8rem;color:#c9d3ea}
    tbody tr{border-top:1px solid rgba(255,255,255,.08)}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:600;letter-spacing:.3px}
    .badge.individual{background:rgba(97,211,249,.2);color:#61d3f9}
    .badge.business{background:rgba(168,132,255,.2);color:#c9a6ff}
    .empty-state{padding:36px 0;text-align:center;color:#c9d3ea}
    .error-state{background:rgba(255,82,82,.18);border:1px solid rgba(255,82,82,.32);padding:18px 20px;border-radius:14px;color:#ffb3b3;margin-bottom:22px}
    .success-state{background:rgba(76,175,80,.18);border:1px solid rgba(76,175,80,.32);padding:18px 20px;border-radius:14px;color:#b4f1b6;margin-bottom:22px;display:none}
    header{display:flex;justify-content:space-between;align-items:flex-start}
    .header-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .track-search-container{display:flex;gap:12px;margin-bottom:20px;align-items:flex-end}
    .search-input-group{flex:1;min-width:250px}
    .search-input-group label{display:block;font-size:.9rem;color:#c9d3ea;font-weight:600;margin-bottom:8px;letter-spacing:.3px}
    .search-input-group input{width:100%;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;font-size:.95rem;transition:all .2s}
    .search-input-group input::placeholder{color:rgba(255,255,255,.5)}
    .search-input-group input:focus{outline:none;border-color:#1c6bff;background:rgba(255,255,255,.08);box-shadow:0 0 0 3px rgba(28,107,255,.2)}
    .search-btn{padding:12px 24px;border-radius:8px;border:none;background:linear-gradient(135deg,#1c6bff,#408eff);color:#fff;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 12px 20px rgba(28,107,255,.3);white-space:nowrap}
    .search-btn:hover{transform:translateY(-2px);box-shadow:0 16px 28px rgba(28,107,255,.4)}
    .tracking-status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-size:.8rem;font-weight:600;letter-spacing:.3px}
    .tracking-status-badge.pending{background:rgba(255,193,7,.2);color:#ffc107}
    .tracking-status-badge.in-transit{background:rgba(33,150,243,.2);color:#2196f3}
    .tracking-status-badge.delivered{background:rgba(76,175,80,.2);color:#4caf50}
    .tracking-status-badge.cancelled{background:rgba(244,67,54,.2);color:#f44336}
    .btn-cancel{padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.06);color:#fff;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-cancel:hover{background:rgba(244,67,54,.2);border-color:rgba(244,67,54,.5);color:#ffb3b3}
    .action-cell{display:flex;gap:10px;align-items:center}
    .muted{opacity:.7}
    @media (max-width:900px){
      .dashboard-container{padding:32px 18px 60px}
      table{min-width:100%}
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <main class="dashboard-container">
    <header>
      <div class="header-content">
        <h1>User Dashboard</h1>
        <p class="subtitle">View your delivered orders and shipments currently on the way.</p>
      </div>
      <div class="header-actions">
        <button class="search-btn" onclick="openTrackingPanel()">Track Order</button>
        <button class="btn-cancel" onclick="handleLogout()">Logout</button>
      </div>
    </header>

    <section id="success-banner" class="success-state"></section>
    <section id="error-banner" class="error-state" style="display:none;"></section>

    <section class="overview-grid">
      <article class="overview-card">
        <h3>Total Orders</h3>
        <div class="metric" id="metric-total-orders">0</div>
        <div class="meta" id="metric-total-orders-meta">0 delivered · 0 in-transit</div>
      </article>
      <article class="overview-card">
        <h3>Delivered</h3>
        <div class="metric" id="metric-delivered">0</div>
        <div class="meta muted">All time</div>
      </article>
      <article class="overview-card">
        <h3>On the Way</h3>
        <div class="metric" id="metric-intransit">0</div>
        <div class="meta muted">Cancelable if eligible</div>
      </article>
    </section>

    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
        <div class="filters" style="margin-bottom:0;">
          <span style="color:#c9d3ea;font-weight:600;">Filter:</span>
          <button type="button" class="active" data-filter="all">All</button>
          <button type="button" data-filter="in-transit">On the way</button>
          <button type="button" data-filter="delivered">Delivered</button>
          <button type="button" data-filter="cancelled">Cancelled</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table aria-label="Your orders">
          <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Status</th>
            <th>Route</th>
            <th>Weight</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody id="orders-table-body">
          <tr><td colspan="7" class="empty-state">Loading your orders…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="trackingPanel" class="track-search-container" style="display:none;">
      <div class="search-input-group">
        <label for="trackingInput">Enter Tracking ID</label>
        <input id="trackingInput" type="text" placeholder="e.g., TRK-001-2025" onkeypress="if(event.key==='Enter') searchTracking()">
      </div>
      <button class="search-btn" onclick="searchTracking()">Search</button>
      <button class="search-btn" onclick="closeTrackingPanel()" style="background:rgba(255,255,255,.1);margin-left:auto;">Close</button>
    </section>

    <section id="trackingResults" style="display:none;margin-bottom:32px;"></section>
  </main>

  <div id="footer"></div>

  <script>
    const countryLabels={bhr:'Bahrain',egy:'Egypt',irn:'Iran',irq:'Iraq',jor:'Jordan',kwt:'Kuwait',lbn:'Lebanon',omn:'Oman',pse:'Palestine',qat:'Qatar',sau:'Saudi Arabia',syr:'Syria',are:'United Arab Emirates',yem:'Yemen'};
    let allOrders=[]; let activeFilter='all';
    const ORDERS_ENDPOINT='/api/my/orders';

    document.addEventListener('DOMContentLoaded',()=>{
      loadSharedPartials();
      attachFilterHandlers();
      loadOrders();
    });

    function loadSharedPartials(){
      fetch('header.html').then(r=>r.text()).then(html=>{document.getElementById('header').innerHTML=html;}).catch(()=>{});
      fetch('footer.html').then(r=>r.text()).then(html=>{document.getElementById('footer').innerHTML=html;}).catch(()=>{});
    }

    function attachFilterHandlers(){
      document.querySelectorAll('.filters button[data-filter]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          activeFilter=btn.dataset.filter;
          renderTable();
        });
      });
    }

    async function loadOrders(){
      setTableLoading(); hideError(); hideSuccess();
      try{
        const res=await fetch(ORDERS_ENDPOINT);
        if(!res.ok) throw new Error(await res.text());
        const data=await res.json();
        allOrders=Array.isArray(data)?data:[];
        updateMetrics(); renderTable();
      }catch(err){
        console.error(err);
        allOrders=[]; updateMetrics();
        setTableError('Unable to load your orders right now.');
        showError(err.message||'Failed to load orders. Please try again later.');
      }
    }

    function setTableLoading(){document.getElementById('orders-table-body').innerHTML=`<tr><td colspan="7" class="empty-state">Loading your orders…</td></tr>`;}
    function setTableEmpty(){document.getElementById('orders-table-body').innerHTML=`<tr><td colspan="7" class="empty-state">No orders found for this filter.</td></tr>`;}
    function setTableError(msg){document.getElementById('orders-table-body').innerHTML=`<tr><td colspan="7" class="empty-state">${msg}</td></tr>`;}

    function renderTable(){
      const tbody=document.getElementById('orders-table-body');
      const filtered=allOrders.filter(o=>{
        if(activeFilter==='all') return true;
        return (o.status||'').toLowerCase()===activeFilter;
      });
      if(!filtered.length){setTableEmpty();return;}
      const rows=filtered.map(o=>{
        const status=(o.status||'pending').toLowerCase();
        const route=formatRoute(o.origin,o.destination,o.shippingMethod);
        const weight=o.weight!=null?`${Number(o.weight).toFixed(1)} kg`:'—';
        const amount=o.shipmentCost!=null?`$${Number(o.shipmentCost).toFixed(2)}`:'—';
        const date=o.orderDate?formatDate(o.orderDate):'—';
        const statusClass=getStatusClass(status);
        const idKey=orderKey(o);
        const canCancel=status==='in-transit';
        const actionHtml=canCancel?`<button class="btn-cancel" onclick="cancelOrder('${encodeURIComponent(idKey)}')">Cancel</button>`:`<span class="muted">—</span>`;
        return `
          <tr>
            <td>${o.trackingID||idKey}</td>
            <td><span class="tracking-status-badge ${statusClass}">${capitalize(status)}</span></td>
            <td>${route}</td>
            <td>${weight}</td>
            <td>${amount}</td>
            <td>${date}</td>
            <td class="action-cell">${actionHtml}</td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML=rows;
    }

    function updateMetrics(){
      const total=allOrders.length;
      const delivered=allOrders.filter(o=>(o.status||'').toLowerCase()==='delivered').length;
      const inTransit=allOrders.filter(o=>(o.status||'').toLowerCase()==='in-transit').length;
      document.getElementById('metric-total-orders').textContent=String(total);
      document.getElementById('metric-delivered').textContent=String(delivered);
      document.getElementById('metric-intransit').textContent=String(inTransit);
      document.getElementById('metric-total-orders-meta').textContent=`${delivered} delivered · ${inTransit} in-transit`;
    }

    async function cancelOrder(encodedKey){
      const id=decodeURIComponent(encodedKey);
      if(!confirm('Are you sure you want to cancel this shipment?')) return;
      hideError(); hideSuccess();
      try{
        const res=await fetch(`/api/orders/${encodeURIComponent(id)}/cancel`,{method:'POST'});
        if(!res.ok) throw new Error(await res.text());
        const idx=allOrders.findIndex(o=>orderKey(o)===id||o.trackingID===id);
        if(idx>-1){allOrders[idx].status='cancelled';}
        updateMetrics(); renderTable(); showSuccess('Order has been cancelled.');
      }catch(err){console.error(err); showError(err.message||'Unable to cancel this order right now.');}
    }

    function orderKey(o){return o.id||o.orderId||o.trackingID;}
    function getStatusClass(s){switch(s){case'delivered':return'delivered';case'in-transit':return'in-transit';case'cancelled':return'cancelled';case'pending':default:return'pending';}}
    function formatRoute(origin,destination,method){
      const o=countryLabels[origin?.toLowerCase?.()]||origin||'—';
      const d=countryLabels[destination?.toLowerCase?.()]||destination||'—';
      const base=`${o} → ${d}`;
      return method?`${base} (${method})`:base;
    }
    function formatDate(v){const d=new Date(v);if(Number.isNaN(d.getTime()))return'—';return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});}
    function capitalize(v){if(!v)return v;return v.charAt(0).toUpperCase()+v.slice(1);}
    function showError(msg){const b=document.getElementById('error-banner');b.textContent=msg;b.style.display='block';}
    function hideError(){const b=document.getElementById('error-banner');b.style.display='none';b.textContent='';}
    function showSuccess(msg){const s=document.getElementById('success-banner');s.textContent=msg;s.style.display='block';}
    function hideSuccess(){const s=document.getElementById('success-banner');s.style.display='none';s.textContent='';}
    function openTrackingPanel(){document.getElementById('trackingPanel').style.display='flex';document.getElementById('trackingInput').focus();}
    function closeTrackingPanel(){document.getElementById('trackingPanel').style.display='none';document.getElementById('trackingResults').style.display='none';document.getElementById('trackingInput').value='';}
    function searchTracking(){
      const id=document.getElementById('trackingInput').value.trim();
      const panel=document.getElementById('trackingResults');
      if(!id){alert('Please enter a tracking ID');return;}
      const order=allOrders.find(o=>(o.trackingID||'').toLowerCase()===id.toLowerCase());
      if(!order){panel.innerHTML=`<div class="error-state">No order found with tracking ID: <strong>${id}</strong></div>`;panel.style.display='block';return;}
      const route=formatRoute(order.origin,order.destination,order.shippingMethod);
      panel.innerHTML=`<div class="success-state" style="display:block;">${order.trackingID}: ${route} — ${capitalize(order.status||'pending')}</div>`;
      panel.style.display='block';
    }
    function handleLogout(){localStorage.removeItem('userToken');window.location.href='home.html';}
  </script>
</body>
</html>
