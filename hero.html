<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Middle East â€” Neon Land, Navy Sea</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js"></script>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; background:#0a1a3f; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

  .mapboxgl-popup { padding-bottom: 8px; }
  .mapboxgl-popup-content {
    font: 600 12px/1.2 "Helvetica Neue", Arial, sans-serif;
    padding: 8px 10px;
    border-radius: 8px;
    background: rgba(10,26,63,0.92);
    color: #00e5ff;
    box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(0,229,255,.18) inset;
    letter-spacing: .2px;
  }
  .mapboxgl-popup-tip { border-top-color: rgba(10,26,63,0.92) !important; }

  .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none !important; }
</style>
</head>
<body>
<div id="map"></div>
<div id="intro-shield" style="position:fixed;inset:0;z-index:999999;background:transparent;"></div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoieG15b290IiwiYSI6ImNqOXdhMDR2OTU4dTgycXBnejAycTc2Z3AifQ.IbKaD_XfuTq69TO9b06e6A';

  var ME_BOUNDS = [[25, 12], [60, 38]];
  var NAVY = '#0a1a3f';
  var NEON = '#00e5ff';
  var HOVER = '#66f0ff';

  var ME_COUNTRIES = [
    'Bahrain','Egypt','Iran','Iraq','Israel','Jordan',
    'Kuwait','Lebanon','Oman','Palestine','Qatar','Saudi Arabia',
    'Syria','Turkey','United Arab Emirates','Yemen'
  ];

  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [20, 20],
    zoom: 0.8,
    attributionControl: false,
    bearing: -8,
    pitch: 30
  });

  function disableAllInteractions(){
    map.dragPan.disable();
    map.scrollZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    map.doubleClickZoom.disable();
    map.touchZoomRotate.disable();
  }
  function enablePanOnly(){
    map.dragPan.enable();      // allow dragging to pan
    map.scrollZoom.disable();  // mouse wheel won't zoom (page will scroll)
    map.boxZoom.disable();
    map.keyboard.disable();    // arrow keys won't hijack page scroll
    map.doubleClickZoom.disable();
    map.touchZoomRotate.disable(); // disables pinch/rotate zoom on touch
  }
  function installShieldHandlers(){
    var s = document.getElementById('intro-shield');
    ['click','mousedown','mouseup','touchstart','touchend','wheel'].forEach(function(evt){
      s.addEventListener(evt, function(e){ e.preventDefault(); e.stopPropagation(); }, { passive:false });
    });
  }
  function removeShield(){
    var s = document.getElementById('intro-shield');
    if(s && s.parentNode) s.parentNode.removeChild(s);
  }

  map.on('load', function () {
    disableAllInteractions();
    installShieldHandlers();

    var introDuration = 4300;
    setTimeout(function () {
      var targetBounds = new mapboxgl.LngLatBounds(ME_BOUNDS);
      var targetCenter = targetBounds.getCenter();
      var targetZoom = 5.4;

      map.easeTo({
        center: targetCenter,
        zoom: targetZoom,
        bearing: 8,
        pitch: 45,
        duration: introDuration,
        easing: function (t) {
          return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }
      });

      setTimeout(function(){
        removeShield();
        enablePanOnly();  // keep pan, let page scroll pass through
        var expandLng = 8, expandLat = 8;
        map.setMaxBounds([
          [ME_BOUNDS[0][0]-expandLng, ME_BOUNDS[0][1]-expandLat],
          [ME_BOUNDS[1][0]+expandLng, ME_BOUNDS[1][1]+expandLat]
        ]);
      }, introDuration + 150);
    }, 150);

    var layers = map.getStyle().layers || [];

    layers.forEach(function (layer) {
      if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
        try { map.setLayoutProperty(layer.id, 'visibility', 'none'); } catch(e){}
      }
    });

    layers.forEach(function (layer) {
      var id = layer.id;
      var keep =
        layer.type === 'background' ||
        id.indexOf('water') > -1 ||
        id.indexOf('admin-0-boundary') > -1 ||
        id.indexOf('admin-1-boundary') > -1;
      if (!keep) {
        try { map.setLayoutProperty(id, 'visibility', 'none'); } catch(e){}
      }
    });

    layers.forEach(function (layer) {
      var id = layer.id;
      if (layer.type === 'background') {
        map.setPaintProperty(id, 'background-color', NAVY);
      }
      if (id.indexOf('water') > -1) {
        if (layer.type === 'fill') {
          map.setPaintProperty(id, 'fill-color', NAVY);
          map.setPaintProperty(id, 'fill-opacity', 1);
        }
        if (layer.type === 'line') {
          map.setPaintProperty(id, 'line-color', NAVY);
          map.setPaintProperty(id, 'line-opacity', 1);
        }
      }
      if ((id.indexOf('admin-0-boundary') > -1 || id.indexOf('admin-1-boundary') > -1) && layer.type === 'line') {
        map.setPaintProperty(id, 'line-color', NAVY);
        map.setPaintProperty(id, 'line-width', 1.2);
        map.setPaintProperty(id, 'line-opacity', 0.6);
      }
    });

    map.addSource('countries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });

    map.addLayer({
      id: 'country-fills',
      type: 'fill',
      source: 'countries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': NEON, 'fill-opacity': 0.92 },
      filter: ['in', 'name_en'].concat(ME_COUNTRIES)
    }, getTopWaterLayerId());

    map.addLayer({
      id: 'country-borders-navy',
      type: 'line',
      source: 'countries',
      'source-layer': 'country_boundaries',
      paint: { 'line-color': NAVY, 'line-width': 1.8, 'line-opacity': 0.9 },
      filter: ['in', 'name_en'].concat(ME_COUNTRIES)
    });

    map.addLayer({
      id: 'country-fills-hover',
      type: 'fill',
      source: 'countries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': HOVER, 'fill-opacity': 0.9 },
      filter: ['==','name_en','']
    });

    var popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
    map.on('mousemove', 'country-fills', function (e) {
      if (!e.features || !e.features.length) return;
      var f = e.features[0];
      var name = f.properties && (f.properties.name_en || f.properties.name);
      var lngLat = e.lngLat;

      map.setFilter('country-fills-hover', ['==','name_en', name]);
      if (lngLat.lng < ME_BOUNDS[0][0] || lngLat.lng > ME_BOUNDS[1][0] ||
          lngLat.lat < ME_BOUNDS[0][1] || lngLat.lat > ME_BOUNDS[1][1]) {
        popup.remove(); return;
      }
      popup.setLngLat(lngLat).setHTML(name || 'Country').addTo(map);
    });
    map.on('mouseleave', 'country-fills', function () {
      map.setFilter('country-fills-hover', ['==', 'name_en', '']);
      popup.remove();
    });

    function getTopWaterLayerId() {
      var waterLayers = (map.getStyle().layers || []).filter(function (l) {
        return l.id.indexOf('water') > -1;
      });
      return waterLayers.length ? waterLayers[waterLayers.length - 1].id : undefined;
    }
  });
</script>
</body>
</html>
